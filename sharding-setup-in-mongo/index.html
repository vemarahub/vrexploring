<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Sharding Setup in Mongo | VR Exploring</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Sharding Setup in Mongo" />
<meta name="author" content="Rajesh Nair" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="To setup mongo sharding environment we should be ideally having the below setups * A Config Databases Replica Set of 3 or more members * Multiple Shard Database Replica Sets * Multiple Mongos Database instances. To set up all the config , shard and mongos instances on a single linux server ( for a real production scenario all should be on different machines) follow the below steps: 1. Create the folders cfg0 cfg1 cfg2 for storing config database replica sets mkdir cfg0 cfg1 cfg2 2. Create the folders a0,a1,a2,b0,b1,b2,c0,c1,c2,d0,d1,d2 for storing shards a,b,c,d replica sets mkdir a0 a1 a2 b0 b1 b2 c0 c1 c2 d0 d1 d2 3.Start the config server instances mongod --configsvr --dbpath cfg0 --port 26050 --fork --logpath log.cfg0 --logappend --replSet cfg mongod --configsvr --dbpath cfg1 --port 26051 --fork --logpath log.cfg1 --logappend --replSet cfg mongod --configsvr --dbpath cfg2 --port 26052 --fork --logpath log.cfg2 --logappend --replSet cfg 4. Initiate Replication in config servers mongo -port 26050 &gt;rs.initiate() &gt;rs.add(&quot;localhost:26051&quot;); &gt;rs.add(&quot;localhost:26052&quot;); &gt;rs.status() 5. Start the shard servers and mongos instances # shard servers (mongod data servers) # note : not to use smallfiles on production nor such small oplogsize mongod --shardsvr --replSet a --dbpath a0 --logpath log.a0 --port 27000 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet a --dbpath a1 --logpath log.a1 --port 27001 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet a --dbpath a2 --logpath log.a2 --port 27002 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet b --dbpath b0 --logpath log.b0 --port 27100 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet b --dbpath b1 --logpath log.b1 --port 27101 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet b --dbpath b2 --logpath log.b2 --port 27102 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet c --dbpath c0 --logpath log.c0 --port 27200 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet c --dbpath c1 --logpath log.c1 --port 27201 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet c --dbpath c2 --logpath log.c2 --port 27202 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet d --dbpath d0 --logpath log.d0 --port 27300 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet d --dbpath d1 --logpath log.d1 --port 27301 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet d --dbpath d2 --logpath log.d2 --port 27302 --fork --logappend --smallfiles --oplogSize 50 # mongos processes mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos0 mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos1 --port 26061 mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos2 --port 26062 mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos3 --port 26063 6. Start each shard replica sets mongo -port 27000 &gt;rs.initiate() &gt;rs.add(&quot;localhost:27001&quot;); &gt;rs.add(&quot;localhost:27002&quot;); &gt;rs.status() 7.After starting all the shard replica sets, add the shards using mongos mongos &gt;sh.addShard(&quot;a/localhost:27000&quot;); &gt;sh.addShard(&quot;b/localhost:27100&quot;); &gt;sh.addShard(&quot;c/localhost:27200&quot;); &gt;sh.addShard(&quot;d/localhost:27300&quot;); &gt;sh.status(); --- Sharding Status --- &nbsp; sharding version: { &nbsp; &nbsp; &nbsp; &nbsp; &quot;_id&quot; : 1, &nbsp; &nbsp; &nbsp; &nbsp; &quot;minCompatibleVersion&quot; : 5, &nbsp; &nbsp; &nbsp; &nbsp; &quot;currentVersion&quot; : 6, &nbsp; &nbsp; &nbsp; &nbsp; &quot;clusterId&quot; : ObjectId(&quot;4c90aebc081921bcddd87de8&quot;) &nbsp; } &nbsp; shards: &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;a&quot;,&nbsp; &quot;host&quot; : &quot;a/localhost:27000,localhost:27001,localhost:27002&quot;,&nbsp; &quot;state&quot; : 1 } &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;b&quot;,&nbsp; &quot;host&quot; : &quot;b/localhost:27100,localhost:27101,localhost:27102&quot;,&nbsp; &quot;state&quot; : 1 } &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;c&quot;,&nbsp; &quot;host&quot; : &quot;c/localhost:27200,localhost:27201,localhost:27202&quot;,&nbsp; &quot;state&quot; : 1 } &nbsp; active mongoses: &nbsp; &nbsp; &nbsp; &nbsp; &quot;4.0.6&quot; : 4 &nbsp; autosplit: &nbsp; &nbsp; &nbsp; &nbsp; Currently enabled: yes &nbsp; balancer: &nbsp; &nbsp; &nbsp; &nbsp; Currently enabled:&nbsp; yes &nbsp; &nbsp; &nbsp; &nbsp; Currently running:&nbsp; no &nbsp; &nbsp; &nbsp; &nbsp; Failed balancer rounds in last 5 attempts:&nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; Migration Results for the last 24 hours: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; No recent migrations &nbsp; databases: &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;config&quot;,&nbsp; &quot;primary&quot; : &quot;config&quot;,&nbsp; &quot;partitioned&quot; : true } To add a database as a sharded database : mongos&gt; sh.enableSharding(&quot;mydb&quot;) { &nbsp; &nbsp; &nbsp; &nbsp; &quot;ok&quot; : 1, &nbsp; &nbsp; &nbsp; &nbsp; &quot;operationTime&quot; : Timestamp(1284550849, 4), &nbsp; &nbsp; &nbsp; &nbsp; &quot;$clusterTime&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;clusterTime&quot; : Timestamp(1284550849, 4), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;signature&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;keyId&quot; : NumberLong(0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp; } } Now if we check sh.status, we can see the database as being sharded and can check to which server it is sharded to : &nbsp; {&nbsp; &quot;_id&quot; : &quot;mydb&quot;,&nbsp; &quot;primary&quot; : &quot;b&quot;,&nbsp; &quot;partitioned&quot; : true,&nbsp; &quot;version&quot; : {&nbsp; &quot;uuid&quot; : UUID(&quot;f35e426a-e540-439b-b9ad-7d3d042e17d2&quot;),&nbsp; &quot;lastMod&quot; : 1 } } We can even shard a particular collection of a database: mongos&gt; sh.shardCollection(&quot;mydb.tester&quot;,{_id:1},true) { &nbsp; &nbsp; &nbsp; &nbsp; &quot;collectionsharded&quot; : &quot;mydb.tester&quot;, &nbsp; &nbsp; &nbsp; &nbsp; &quot;collectionUUID&quot; : UUID(&quot;b0027a1d-1e0c-4769-9b65-88eecb9808fc&quot;), &nbsp; &nbsp; &nbsp; &nbsp; &quot;ok&quot; : 1, &nbsp; &nbsp; &nbsp; &nbsp; &quot;operationTime&quot; : Timestamp(1284551103, 10), &nbsp; &nbsp; &nbsp; &nbsp; &quot;$clusterTime&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;clusterTime&quot; : Timestamp(1284551103, 10), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;signature&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;keyId&quot; : NumberLong(0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp; } } Now if we check sh.status() , we can see which sharded server is the collection chunk placed &nbsp;mydb.tester &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shard key: { &quot;_id&quot; : 1 } &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unique: true &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; balancing: true &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chunks: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b&nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { &quot;_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;_id&quot; : { &quot;$maxKey&quot; : 1 } } on : b Timestamp(1, 0) You can also check the shards in the sharded cluster using: mongos&gt; db.shards.find() { &quot;_id&quot; : &quot;a&quot;, &quot;host&quot; : &quot;a/localhost:27000,localhost:27001,localhost:27002&quot;, &quot;state&quot; : 1 } { &quot;_id&quot; : &quot;b&quot;, &quot;host&quot; : &quot;b/localhost:27100,localhost:27101,localhost:27102&quot;, &quot;state&quot; : 1 } { &quot;_id&quot; : &quot;c&quot;, &quot;host&quot; : &quot;c/localhost:27200,localhost:27201,localhost:27202&quot;, &quot;state&quot; : 1 } { &quot;_id&quot; : &quot;d&quot;, &quot;host&quot; : &quot;d/localhost:27300,localhost:27301,localhost:27302&quot;, &quot;state&quot; : 1 } After we insert data into a collection, we can check to which shard the data has fallen by using getLastErrorObj mongos&gt; db.myCol.insert({a:-1}) WriteResult({ &quot;nInserted&quot; : 1 }) mongos&gt; db.getLastErrorObj() { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;n&quot; : 0, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;singleShard&quot; : &quot;localhost:27200&quot;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;err&quot; : null, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ok&quot; : 1, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;$clusterTime&quot; : { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;clusterTime&quot; : Timestamp(1524570077, 611), &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;signature&quot; : { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;), &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;keyId&quot; : NumberLong(0) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;operationTime&quot; : Timestamp(1524570077, 611) } Scatter/Gather &gt;db.myCol.createIndex({x:1}) &gt;db.myCol.find({x:1}).explain() The queries that use either shard keys , or a shard key prefix, are not scatter gather.They will be targeted only at those shards that contain the documents that will be returned by the query. Example: For collection people , shard key : { friends:1,name:-1}.Index are : {name:1,phoneNumber:1}. db.people.find({friends:”Bob”,name:”Emily”}) is not scatter / gather query db.people.find({name:”Alice”}) is scatter gather" />
<meta property="og:description" content="To setup mongo sharding environment we should be ideally having the below setups * A Config Databases Replica Set of 3 or more members * Multiple Shard Database Replica Sets * Multiple Mongos Database instances. To set up all the config , shard and mongos instances on a single linux server ( for a real production scenario all should be on different machines) follow the below steps: 1. Create the folders cfg0 cfg1 cfg2 for storing config database replica sets mkdir cfg0 cfg1 cfg2 2. Create the folders a0,a1,a2,b0,b1,b2,c0,c1,c2,d0,d1,d2 for storing shards a,b,c,d replica sets mkdir a0 a1 a2 b0 b1 b2 c0 c1 c2 d0 d1 d2 3.Start the config server instances mongod --configsvr --dbpath cfg0 --port 26050 --fork --logpath log.cfg0 --logappend --replSet cfg mongod --configsvr --dbpath cfg1 --port 26051 --fork --logpath log.cfg1 --logappend --replSet cfg mongod --configsvr --dbpath cfg2 --port 26052 --fork --logpath log.cfg2 --logappend --replSet cfg 4. Initiate Replication in config servers mongo -port 26050 &gt;rs.initiate() &gt;rs.add(&quot;localhost:26051&quot;); &gt;rs.add(&quot;localhost:26052&quot;); &gt;rs.status() 5. Start the shard servers and mongos instances # shard servers (mongod data servers) # note : not to use smallfiles on production nor such small oplogsize mongod --shardsvr --replSet a --dbpath a0 --logpath log.a0 --port 27000 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet a --dbpath a1 --logpath log.a1 --port 27001 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet a --dbpath a2 --logpath log.a2 --port 27002 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet b --dbpath b0 --logpath log.b0 --port 27100 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet b --dbpath b1 --logpath log.b1 --port 27101 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet b --dbpath b2 --logpath log.b2 --port 27102 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet c --dbpath c0 --logpath log.c0 --port 27200 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet c --dbpath c1 --logpath log.c1 --port 27201 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet c --dbpath c2 --logpath log.c2 --port 27202 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet d --dbpath d0 --logpath log.d0 --port 27300 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet d --dbpath d1 --logpath log.d1 --port 27301 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet d --dbpath d2 --logpath log.d2 --port 27302 --fork --logappend --smallfiles --oplogSize 50 # mongos processes mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos0 mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos1 --port 26061 mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos2 --port 26062 mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos3 --port 26063 6. Start each shard replica sets mongo -port 27000 &gt;rs.initiate() &gt;rs.add(&quot;localhost:27001&quot;); &gt;rs.add(&quot;localhost:27002&quot;); &gt;rs.status() 7.After starting all the shard replica sets, add the shards using mongos mongos &gt;sh.addShard(&quot;a/localhost:27000&quot;); &gt;sh.addShard(&quot;b/localhost:27100&quot;); &gt;sh.addShard(&quot;c/localhost:27200&quot;); &gt;sh.addShard(&quot;d/localhost:27300&quot;); &gt;sh.status(); --- Sharding Status --- &nbsp; sharding version: { &nbsp; &nbsp; &nbsp; &nbsp; &quot;_id&quot; : 1, &nbsp; &nbsp; &nbsp; &nbsp; &quot;minCompatibleVersion&quot; : 5, &nbsp; &nbsp; &nbsp; &nbsp; &quot;currentVersion&quot; : 6, &nbsp; &nbsp; &nbsp; &nbsp; &quot;clusterId&quot; : ObjectId(&quot;4c90aebc081921bcddd87de8&quot;) &nbsp; } &nbsp; shards: &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;a&quot;,&nbsp; &quot;host&quot; : &quot;a/localhost:27000,localhost:27001,localhost:27002&quot;,&nbsp; &quot;state&quot; : 1 } &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;b&quot;,&nbsp; &quot;host&quot; : &quot;b/localhost:27100,localhost:27101,localhost:27102&quot;,&nbsp; &quot;state&quot; : 1 } &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;c&quot;,&nbsp; &quot;host&quot; : &quot;c/localhost:27200,localhost:27201,localhost:27202&quot;,&nbsp; &quot;state&quot; : 1 } &nbsp; active mongoses: &nbsp; &nbsp; &nbsp; &nbsp; &quot;4.0.6&quot; : 4 &nbsp; autosplit: &nbsp; &nbsp; &nbsp; &nbsp; Currently enabled: yes &nbsp; balancer: &nbsp; &nbsp; &nbsp; &nbsp; Currently enabled:&nbsp; yes &nbsp; &nbsp; &nbsp; &nbsp; Currently running:&nbsp; no &nbsp; &nbsp; &nbsp; &nbsp; Failed balancer rounds in last 5 attempts:&nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; Migration Results for the last 24 hours: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; No recent migrations &nbsp; databases: &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;config&quot;,&nbsp; &quot;primary&quot; : &quot;config&quot;,&nbsp; &quot;partitioned&quot; : true } To add a database as a sharded database : mongos&gt; sh.enableSharding(&quot;mydb&quot;) { &nbsp; &nbsp; &nbsp; &nbsp; &quot;ok&quot; : 1, &nbsp; &nbsp; &nbsp; &nbsp; &quot;operationTime&quot; : Timestamp(1284550849, 4), &nbsp; &nbsp; &nbsp; &nbsp; &quot;$clusterTime&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;clusterTime&quot; : Timestamp(1284550849, 4), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;signature&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;keyId&quot; : NumberLong(0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp; } } Now if we check sh.status, we can see the database as being sharded and can check to which server it is sharded to : &nbsp; {&nbsp; &quot;_id&quot; : &quot;mydb&quot;,&nbsp; &quot;primary&quot; : &quot;b&quot;,&nbsp; &quot;partitioned&quot; : true,&nbsp; &quot;version&quot; : {&nbsp; &quot;uuid&quot; : UUID(&quot;f35e426a-e540-439b-b9ad-7d3d042e17d2&quot;),&nbsp; &quot;lastMod&quot; : 1 } } We can even shard a particular collection of a database: mongos&gt; sh.shardCollection(&quot;mydb.tester&quot;,{_id:1},true) { &nbsp; &nbsp; &nbsp; &nbsp; &quot;collectionsharded&quot; : &quot;mydb.tester&quot;, &nbsp; &nbsp; &nbsp; &nbsp; &quot;collectionUUID&quot; : UUID(&quot;b0027a1d-1e0c-4769-9b65-88eecb9808fc&quot;), &nbsp; &nbsp; &nbsp; &nbsp; &quot;ok&quot; : 1, &nbsp; &nbsp; &nbsp; &nbsp; &quot;operationTime&quot; : Timestamp(1284551103, 10), &nbsp; &nbsp; &nbsp; &nbsp; &quot;$clusterTime&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;clusterTime&quot; : Timestamp(1284551103, 10), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;signature&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;keyId&quot; : NumberLong(0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp; } } Now if we check sh.status() , we can see which sharded server is the collection chunk placed &nbsp;mydb.tester &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shard key: { &quot;_id&quot; : 1 } &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unique: true &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; balancing: true &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chunks: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b&nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { &quot;_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;_id&quot; : { &quot;$maxKey&quot; : 1 } } on : b Timestamp(1, 0) You can also check the shards in the sharded cluster using: mongos&gt; db.shards.find() { &quot;_id&quot; : &quot;a&quot;, &quot;host&quot; : &quot;a/localhost:27000,localhost:27001,localhost:27002&quot;, &quot;state&quot; : 1 } { &quot;_id&quot; : &quot;b&quot;, &quot;host&quot; : &quot;b/localhost:27100,localhost:27101,localhost:27102&quot;, &quot;state&quot; : 1 } { &quot;_id&quot; : &quot;c&quot;, &quot;host&quot; : &quot;c/localhost:27200,localhost:27201,localhost:27202&quot;, &quot;state&quot; : 1 } { &quot;_id&quot; : &quot;d&quot;, &quot;host&quot; : &quot;d/localhost:27300,localhost:27301,localhost:27302&quot;, &quot;state&quot; : 1 } After we insert data into a collection, we can check to which shard the data has fallen by using getLastErrorObj mongos&gt; db.myCol.insert({a:-1}) WriteResult({ &quot;nInserted&quot; : 1 }) mongos&gt; db.getLastErrorObj() { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;n&quot; : 0, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;singleShard&quot; : &quot;localhost:27200&quot;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;err&quot; : null, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ok&quot; : 1, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;$clusterTime&quot; : { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;clusterTime&quot; : Timestamp(1524570077, 611), &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;signature&quot; : { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;), &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;keyId&quot; : NumberLong(0) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;operationTime&quot; : Timestamp(1524570077, 611) } Scatter/Gather &gt;db.myCol.createIndex({x:1}) &gt;db.myCol.find({x:1}).explain() The queries that use either shard keys , or a shard key prefix, are not scatter gather.They will be targeted only at those shards that contain the documents that will be returned by the query. Example: For collection people , shard key : { friends:1,name:-1}.Index are : {name:1,phoneNumber:1}. db.people.find({friends:”Bob”,name:”Emily”}) is not scatter / gather query db.people.find({name:”Alice”}) is scatter gather" />
<link rel="canonical" href="https://vemarahub.github.io/vrexploring/sharding-setup-in-mongo/" />
<meta property="og:url" content="https://vemarahub.github.io/vrexploring/sharding-setup-in-mongo/" />
<meta property="og:site_name" content="VR Exploring" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-29T13:59:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Sharding Setup in Mongo" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Rajesh Nair"},"dateModified":"2019-03-29T13:59:00+00:00","datePublished":"2019-03-29T13:59:00+00:00","description":"To setup mongo sharding environment we should be ideally having the below setups * A Config Databases Replica Set of 3 or more members * Multiple Shard Database Replica Sets * Multiple Mongos Database instances. To set up all the config , shard and mongos instances on a single linux server ( for a real production scenario all should be on different machines) follow the below steps: 1. Create the folders cfg0 cfg1 cfg2 for storing config database replica sets mkdir cfg0 cfg1 cfg2 2. Create the folders a0,a1,a2,b0,b1,b2,c0,c1,c2,d0,d1,d2 for storing shards a,b,c,d replica sets mkdir a0 a1 a2 b0 b1 b2 c0 c1 c2 d0 d1 d2 3.Start the config server instances mongod --configsvr --dbpath cfg0 --port 26050 --fork --logpath log.cfg0 --logappend --replSet cfg mongod --configsvr --dbpath cfg1 --port 26051 --fork --logpath log.cfg1 --logappend --replSet cfg mongod --configsvr --dbpath cfg2 --port 26052 --fork --logpath log.cfg2 --logappend --replSet cfg 4. Initiate Replication in config servers mongo -port 26050 &gt;rs.initiate() &gt;rs.add(&quot;localhost:26051&quot;); &gt;rs.add(&quot;localhost:26052&quot;); &gt;rs.status() 5. Start the shard servers and mongos instances # shard servers (mongod data servers) # note : not to use smallfiles on production nor such small oplogsize mongod --shardsvr --replSet a --dbpath a0 --logpath log.a0 --port 27000 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet a --dbpath a1 --logpath log.a1 --port 27001 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet a --dbpath a2 --logpath log.a2 --port 27002 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet b --dbpath b0 --logpath log.b0 --port 27100 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet b --dbpath b1 --logpath log.b1 --port 27101 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet b --dbpath b2 --logpath log.b2 --port 27102 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet c --dbpath c0 --logpath log.c0 --port 27200 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet c --dbpath c1 --logpath log.c1 --port 27201 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet c --dbpath c2 --logpath log.c2 --port 27202 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet d --dbpath d0 --logpath log.d0 --port 27300 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet d --dbpath d1 --logpath log.d1 --port 27301 --fork --logappend --smallfiles --oplogSize 50 mongod --shardsvr --replSet d --dbpath d2 --logpath log.d2 --port 27302 --fork --logappend --smallfiles --oplogSize 50 # mongos processes mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos0 mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos1 --port 26061 mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos2 --port 26062 mongos --configdb &quot;cfg/localhost:26050,localhost:26051,localhost:26052&quot; --fork --logpath log.mongos3 --port 26063 6. Start each shard replica sets mongo -port 27000 &gt;rs.initiate() &gt;rs.add(&quot;localhost:27001&quot;); &gt;rs.add(&quot;localhost:27002&quot;); &gt;rs.status() 7.After starting all the shard replica sets, add the shards using mongos mongos &gt;sh.addShard(&quot;a/localhost:27000&quot;); &gt;sh.addShard(&quot;b/localhost:27100&quot;); &gt;sh.addShard(&quot;c/localhost:27200&quot;); &gt;sh.addShard(&quot;d/localhost:27300&quot;); &gt;sh.status(); --- Sharding Status --- &nbsp; sharding version: { &nbsp; &nbsp; &nbsp; &nbsp; &quot;_id&quot; : 1, &nbsp; &nbsp; &nbsp; &nbsp; &quot;minCompatibleVersion&quot; : 5, &nbsp; &nbsp; &nbsp; &nbsp; &quot;currentVersion&quot; : 6, &nbsp; &nbsp; &nbsp; &nbsp; &quot;clusterId&quot; : ObjectId(&quot;4c90aebc081921bcddd87de8&quot;) &nbsp; } &nbsp; shards: &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;a&quot;,&nbsp; &quot;host&quot; : &quot;a/localhost:27000,localhost:27001,localhost:27002&quot;,&nbsp; &quot;state&quot; : 1 } &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;b&quot;,&nbsp; &quot;host&quot; : &quot;b/localhost:27100,localhost:27101,localhost:27102&quot;,&nbsp; &quot;state&quot; : 1 } &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;c&quot;,&nbsp; &quot;host&quot; : &quot;c/localhost:27200,localhost:27201,localhost:27202&quot;,&nbsp; &quot;state&quot; : 1 } &nbsp; active mongoses: &nbsp; &nbsp; &nbsp; &nbsp; &quot;4.0.6&quot; : 4 &nbsp; autosplit: &nbsp; &nbsp; &nbsp; &nbsp; Currently enabled: yes &nbsp; balancer: &nbsp; &nbsp; &nbsp; &nbsp; Currently enabled:&nbsp; yes &nbsp; &nbsp; &nbsp; &nbsp; Currently running:&nbsp; no &nbsp; &nbsp; &nbsp; &nbsp; Failed balancer rounds in last 5 attempts:&nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; Migration Results for the last 24 hours: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; No recent migrations &nbsp; databases: &nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &quot;_id&quot; : &quot;config&quot;,&nbsp; &quot;primary&quot; : &quot;config&quot;,&nbsp; &quot;partitioned&quot; : true } To add a database as a sharded database : mongos&gt; sh.enableSharding(&quot;mydb&quot;) { &nbsp; &nbsp; &nbsp; &nbsp; &quot;ok&quot; : 1, &nbsp; &nbsp; &nbsp; &nbsp; &quot;operationTime&quot; : Timestamp(1284550849, 4), &nbsp; &nbsp; &nbsp; &nbsp; &quot;$clusterTime&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;clusterTime&quot; : Timestamp(1284550849, 4), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;signature&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;keyId&quot; : NumberLong(0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp; } } Now if we check sh.status, we can see the database as being sharded and can check to which server it is sharded to : &nbsp; {&nbsp; &quot;_id&quot; : &quot;mydb&quot;,&nbsp; &quot;primary&quot; : &quot;b&quot;,&nbsp; &quot;partitioned&quot; : true,&nbsp; &quot;version&quot; : {&nbsp; &quot;uuid&quot; : UUID(&quot;f35e426a-e540-439b-b9ad-7d3d042e17d2&quot;),&nbsp; &quot;lastMod&quot; : 1 } } We can even shard a particular collection of a database: mongos&gt; sh.shardCollection(&quot;mydb.tester&quot;,{_id:1},true) { &nbsp; &nbsp; &nbsp; &nbsp; &quot;collectionsharded&quot; : &quot;mydb.tester&quot;, &nbsp; &nbsp; &nbsp; &nbsp; &quot;collectionUUID&quot; : UUID(&quot;b0027a1d-1e0c-4769-9b65-88eecb9808fc&quot;), &nbsp; &nbsp; &nbsp; &nbsp; &quot;ok&quot; : 1, &nbsp; &nbsp; &nbsp; &nbsp; &quot;operationTime&quot; : Timestamp(1284551103, 10), &nbsp; &nbsp; &nbsp; &nbsp; &quot;$clusterTime&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;clusterTime&quot; : Timestamp(1284551103, 10), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;signature&quot; : { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;keyId&quot; : NumberLong(0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp; } } Now if we check sh.status() , we can see which sharded server is the collection chunk placed &nbsp;mydb.tester &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shard key: { &quot;_id&quot; : 1 } &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unique: true &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; balancing: true &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chunks: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b&nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { &quot;_id&quot; : { &quot;$minKey&quot; : 1 } } --&gt;&gt; { &quot;_id&quot; : { &quot;$maxKey&quot; : 1 } } on : b Timestamp(1, 0) You can also check the shards in the sharded cluster using: mongos&gt; db.shards.find() { &quot;_id&quot; : &quot;a&quot;, &quot;host&quot; : &quot;a/localhost:27000,localhost:27001,localhost:27002&quot;, &quot;state&quot; : 1 } { &quot;_id&quot; : &quot;b&quot;, &quot;host&quot; : &quot;b/localhost:27100,localhost:27101,localhost:27102&quot;, &quot;state&quot; : 1 } { &quot;_id&quot; : &quot;c&quot;, &quot;host&quot; : &quot;c/localhost:27200,localhost:27201,localhost:27202&quot;, &quot;state&quot; : 1 } { &quot;_id&quot; : &quot;d&quot;, &quot;host&quot; : &quot;d/localhost:27300,localhost:27301,localhost:27302&quot;, &quot;state&quot; : 1 } After we insert data into a collection, we can check to which shard the data has fallen by using getLastErrorObj mongos&gt; db.myCol.insert({a:-1}) WriteResult({ &quot;nInserted&quot; : 1 }) mongos&gt; db.getLastErrorObj() { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;n&quot; : 0, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;singleShard&quot; : &quot;localhost:27200&quot;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;err&quot; : null, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ok&quot; : 1, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;$clusterTime&quot; : { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;clusterTime&quot; : Timestamp(1524570077, 611), &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;signature&quot; : { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;), &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;keyId&quot; : NumberLong(0) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;operationTime&quot; : Timestamp(1524570077, 611) } Scatter/Gather &gt;db.myCol.createIndex({x:1}) &gt;db.myCol.find({x:1}).explain() The queries that use either shard keys , or a shard key prefix, are not scatter gather.They will be targeted only at those shards that contain the documents that will be returned by the query. Example: For collection people , shard key : { friends:1,name:-1}.Index are : {name:1,phoneNumber:1}. db.people.find({friends:”Bob”,name:”Emily”}) is not scatter / gather query db.people.find({name:”Alice”}) is scatter gather","headline":"Sharding Setup in Mongo","mainEntityOfPage":{"@type":"WebPage","@id":"https://vemarahub.github.io/vrexploring/sharding-setup-in-mongo/"},"url":"https://vemarahub.github.io/vrexploring/sharding-setup-in-mongo/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/vrexploring/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://vemarahub.github.io/vrexploring/feed.xml" title="VR Exploring" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/vrexploring/">VR Exploring</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/vrexploring/about/">About</a><a class="page-link" href="/vrexploring/">Home</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Sharding Setup in Mongo</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-03-29T13:59:00+00:00" itemprop="datePublished">Mar 29, 2019
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Rajesh Nair</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div dir="ltr" style="text-align: left;" trbidi="on">
<div class="sidenav">
To setup mongo sharding environment we should be ideally having the below setups</div>
<div dir="ltr" style="text-align: left;" trbidi="on">
<br />
* A <b>Config </b>Databases Replica Set of 3 or more members<br />
* Multiple <b>Shard </b>Database Replica Sets<br />
* Multiple <b>Mongos </b>Database instances.<br />
<br />
To set up all the config , shard and mongos instances on a single linux server ( for a real production scenario all should be on different machines) follow the below steps:<br />
<br />
1. Create the folders cfg0 cfg1 cfg2 for storing config database replica sets<br />
<b>mkdir cfg0 cfg1 cfg2</b><br />
<b><br /></b>
2. Create the folders a0,a1,a2,b0,b1,b2,c0,c1,c2,d0,d1,d2 for storing shards a,b,c,d replica sets<br />
<b>mkdir a0 a1 a2 b0 b1 b2 c0 c1 c2 d0 d1 d2</b><br />
<b><br /></b>
3.Start the config server instances<br />
<b>mongod --configsvr --dbpath cfg0 --port 26050 --fork --logpath log.cfg0 --logappend --replSet cfg</b><br />
<b>mongod --configsvr --dbpath cfg1 --port 26051 --fork --logpath log.cfg1 --logappend --replSet cfg</b><br />
<b>mongod --configsvr --dbpath cfg2 --port 26052 --fork --logpath log.cfg2 --logappend --replSet cfg</b><br />
<div>
<br /></div>
<div>
4. Initiate Replication in config servers</div>
<div>
<b>mongo -port 26050</b></div>
<div>
<b>&gt;rs.initiate()</b></div>
<div>
<b>&gt;rs.add("localhost:26051");</b></div>
<div>
<b>&gt;rs.add("localhost:26052");</b></div>
<div>
<b>&gt;rs.status()</b></div>
<div>
<b><br /></b></div>
<div>
5. Start the shard servers and mongos instances</div>
<div>
<div>
# shard servers (mongod data servers)</div>
<div>
# note : not to use smallfiles on production nor such small oplogsize</div>
<div>
<b>mongod --shardsvr --replSet a --dbpath a0 --logpath log.a0 --port 27000 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet a --dbpath a1 --logpath log.a1 --port 27001 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet a --dbpath a2 --logpath log.a2 --port 27002 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet b --dbpath b0 --logpath log.b0 --port 27100 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet b --dbpath b1 --logpath log.b1 --port 27101 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet b --dbpath b2 --logpath log.b2 --port 27102 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet c --dbpath c0 --logpath log.c0 --port 27200 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet c --dbpath c1 --logpath log.c1 --port 27201 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet c --dbpath c2 --logpath log.c2 --port 27202 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet d --dbpath d0 --logpath log.d0 --port 27300 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet d --dbpath d1 --logpath log.d1 --port 27301 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<b>mongod --shardsvr --replSet d --dbpath d2 --logpath log.d2 --port 27302 --fork --logappend --smallfiles --oplogSize 50</b></div>
<div>
<br /></div>
<div>
<br /></div>
<div>
# mongos processes</div>
<div>
<b>mongos --configdb "cfg/localhost:26050,localhost:26051,localhost:26052" --fork --logpath log.mongos0</b></div>
<div>
<b>mongos --configdb "cfg/localhost:26050,localhost:26051,localhost:26052" --fork --logpath log.mongos1 --port 26061</b></div>
<div>
<b>mongos --configdb "cfg/localhost:26050,localhost:26051,localhost:26052" --fork --logpath log.mongos2 --port 26062</b></div>
<div>
<b>mongos --configdb "cfg/localhost:26050,localhost:26051,localhost:26052" --fork --logpath log.mongos3 --port 26063</b></div>
</div>
<div>
<br /></div>
<div>
6. Start each shard replica sets</div>
<div>
<b>mongo -port 27000</b></div>
<div>
<b>&gt;rs.initiate()</b></div>
<div>
<b>&gt;rs.add("localhost:27001");</b></div>
<div>
<b>&gt;rs.add("localhost:27002");</b></div>
<div>
<b>&gt;rs.status()</b></div>
<div>
<br /></div>
<div>
7.After starting all the shard replica sets, add the shards using mongos</div>
<div>
<b>mongos</b></div>
<div>
<b>&gt;sh.addShard("a/localhost:27000");</b></div>
<div>
<b>&gt;sh.addShard("b/localhost:27100");</b></div>
<div>
<b>&gt;sh.addShard("c/localhost:27200");</b></div>
<div>
<b>&gt;sh.addShard("d/localhost:27300");</b></div>
<div>
<br />
<b>&gt;sh.status();</b><br />
<i>--- Sharding Status ---</i><br />
<i>&nbsp; sharding version: {</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; "_id" : 1,</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; "minCompatibleVersion" : 5,</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; "currentVersion" : 6,</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; "clusterId" : ObjectId("4c90aebc081921bcddd87de8")</i><br />
<i>&nbsp; }</i><br />
<i>&nbsp; shards:</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; "_id" : "a",&nbsp; "host" : "a/localhost:27000,localhost:27001,localhost:27002",&nbsp; "state" : 1 }</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; "_id" : "b",&nbsp; "host" : "b/localhost:27100,localhost:27101,localhost:27102",&nbsp; "state" : 1 }</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; "_id" : "c",&nbsp; "host" : "c/localhost:27200,localhost:27201,localhost:27202",&nbsp; "state" : 1 }</i><br />
<i>&nbsp; active mongoses:</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; "4.0.6" : 4</i><br />
<i>&nbsp; autosplit:</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; Currently enabled: yes</i><br />
<i>&nbsp; balancer:</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; Currently enabled:&nbsp; yes</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; Currently running:&nbsp; no</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; Failed balancer rounds in last 5 attempts:&nbsp; 0</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; Migration Results for the last 24 hours:</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; No recent migrations</i><br />
<i>&nbsp; databases:</i><br />
<br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; "_id" : "config",&nbsp; "primary" : "config",&nbsp; "partitioned" : true }</i></div>
<div>
<br />
To add a database as a sharded database :<br />
<b>mongos&gt; sh.enableSharding("mydb")</b><br />
<i>{</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; "ok" : 1,</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; "operationTime" : Timestamp(1284550849, 4),</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; "$clusterTime" : {</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "clusterTime" : Timestamp(1284550849, 4),</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "signature" : {</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "keyId" : NumberLong(0)</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</i><br />
<i>&nbsp; &nbsp; &nbsp; &nbsp; }</i><br />
<i>}</i></div>
<div>
<br /></div>
<div>
Now if we check sh.status, we can see the database as being sharded and can check to which server it is sharded to :</div>
<div>
<br /></div>
<div>
<div>
<i>&nbsp; {&nbsp; "_id" : "mydb",&nbsp; "primary" : "b",&nbsp; "partitioned" : true,&nbsp; "version" : {&nbsp; "uuid" : UUID("f35e426a-e540-439b-b9ad-7d3d042e17d2"),&nbsp; "lastMod" : 1 } }</i></div>
<div>
<i><br /></i></div>
<div>
<i><br /></i></div>
<div>
We can even shard a particular collection of a database:</div>
<div>
<br /></div>
<div>
<div>
<b>mongos&gt; sh.shardCollection("mydb.tester",{_id:1},true)</b></div>
<div>
<i>{</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; "collectionsharded" : "mydb.tester",</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; "collectionUUID" : UUID("b0027a1d-1e0c-4769-9b65-88eecb9808fc"),</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; "ok" : 1,</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; "operationTime" : Timestamp(1284551103, 10),</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; "$clusterTime" : {</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "clusterTime" : Timestamp(1284551103, 10),</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "signature" : {</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "keyId" : NumberLong(0)</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; }</i></div>
<div>
<i>}</i></div>
</div>
</div>
<div>
<br /></div>
<div>
Now if we check sh.status() , we can see which sharded server is the collection chunk placed</div>
<div>
<br /></div>
<div>
<div>
<i>&nbsp;mydb.tester</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shard key: { "_id" : 1 }</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unique: true</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; balancing: true</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chunks:</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b&nbsp; &nbsp; &nbsp; &nbsp;1</i></div>
<div>
<i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { "_id" : { "$minKey" : 1 } } --&gt;&gt; { "_id" : { "$maxKey" : 1 } } on : b Timestamp(1, 0)</i></div>
<div>
<br />
<br />
You can also check the shards in the sharded cluster using:<br />
<br />
<b>mongos&gt; db.shards.find()</b><br />
<i>{ "_id" : "a", "host" : "a/localhost:27000,localhost:27001,localhost:27002", "state" : 1 }</i><br />
<i>{ "_id" : "b", "host" : "b/localhost:27100,localhost:27101,localhost:27102", "state" : 1 }</i><br />
<i>{ "_id" : "c", "host" : "c/localhost:27200,localhost:27201,localhost:27202", "state" : 1 }</i><br />
<i>{ "_id" : "d", "host" : "d/localhost:27300,localhost:27301,localhost:27302", "state" : 1 }</i><br />
<i><br /></i>
After we insert data into a collection, we can check to which shard the data has fallen by using getLastErrorObj<br />
<br />
<div class="MsoNormal">
<b>mongos&gt;
db.myCol.insert({a:-1})<o:p></o:p></b></div>
<div class="MsoNormal">
<i>WriteResult({ "nInserted" : 1 })</i><o:p></o:p></div>
<div class="MsoNormal">
<b>mongos&gt;
db.getLastErrorObj()<o:p></o:p></b></div>
<div class="MsoNormal">
<i>{<o:p></o:p></i></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "n"
: 0,<o:p></o:p></i></div>
<div class="MsoNormal">
<b><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "singleShard" :
"localhost:27200",<o:p></o:p></i></b></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"err" : null,<o:p></o:p></i></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ok"
: 1,<o:p></o:p></i></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"$clusterTime" : {<o:p></o:p></i></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"clusterTime" : Timestamp(1524570077, 611),<o:p></o:p></i></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"signature" : {<o:p></o:p></i></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),<o:p></o:p></i></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"keyId" : NumberLong(0)<o:p></o:p></i></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<o:p></o:p></i></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<o:p></o:p></i></div>
<div class="MsoNormal">
<i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
"operationTime" : Timestamp(1524570077, 611)<o:p></o:p></i></div>
<br />
<div class="MsoNormal">
<i>}</i><o:p></o:p></div>
<i><br /></i>
<br />
<h3 style="text-align: left;">
<b style="mso-bidi-font-weight: normal;">Scatter/Gather</b></h3>
<div class="MsoNormal">
&gt;db.myCol.createIndex({x:1})<o:p></o:p></div>
<div class="MsoNormal">
&gt;db.myCol.find({x:1}).explain()<o:p></o:p></div>
<div class="MsoNormal">
<br /></div>
<div class="MsoNormal">
The queries that use either shard keys , or a shard key
prefix, are not scatter gather.They will be targeted only at those shards that
contain the documents that will be returned by the query.<o:p></o:p></div>
<div class="MsoNormal">
Example:<o:p></o:p></div>
<div class="MsoNormal">
For collection people , shard key : { friends:1,name:-1}.Index
are : {name:1,phoneNumber:1}.<o:p></o:p></div>
<div class="MsoNormal">
<br /></div>
<div class="MsoNormal">
db.people.find({friends:”Bob”,name:”Emily”}) is not scatter
/ gather query<o:p></o:p></div>
<div class="MsoNormal">
db.people.find({name:”Alice”}) is scatter gather<o:p></o:p></div>
<div class="MsoNormal">
<br /></div>
<i></i></div>
</div>
</div>
</div>

  </div><a class="u-url" href="/vrexploring/sharding-setup-in-mongo/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/vrexploring/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">VR Exploring</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">VR Exploring</li><li><a class="u-email" href="mailto:vrexploring@gmail.com">vrexploring@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/vemarahub"><svg class="svg-icon"><use xlink:href="/vrexploring/assets/minima-social-icons.svg#github"></use></svg> <span class="username">vemarahub</span></a></li><li><a href="https://www.twitter.com/vrexploring"><svg class="svg-icon"><use xlink:href="/vrexploring/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">vrexploring</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A space where i share my thoughts and experiences about technology , science, life, family and everything in between.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
